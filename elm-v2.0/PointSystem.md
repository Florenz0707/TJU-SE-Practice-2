# 积分系统业务流程说明

## 概述

积分系统是"吃饱了吗"点餐平台的核心功能模块之一，用于管理用户的积分获取、消费和过期。系统支持多种积分获取渠道（订单、评价、登录、注册），并实现了积分冻结、扣除和回滚机制，确保积分交易的准确性和一致性。

## 核心概念

### 1. 积分账户（PointsAccount）

每个用户拥有一个积分账户，记录：

- **总积分**：用户累计获得的所有积分
- **冻结积分**：当前被锁定用于订单抵扣的积分
- **可用积分**：总积分 - 冻结积分，可用于抵扣的积分

### 2. 积分批次（PointsBatch）

积分以批次形式存储，每个批次包含：

- **积分数量**：该批次包含的积分
- **过期时间**：积分的有效期（null表示永久有效）
- **可用积分**：该批次中未被冻结的积分
- **冻结积分**：该批次中被锁定的积分

**FIFO原则**：系统按照过期时间优先（FIFO）原则管理积分，优先使用即将过期的积分。

### 3. 积分记录（PointsRecord）

记录所有积分变动：

- **获取（EARN）**：通过订单、评价等方式获得积分
- **消费（CONSUME）**：使用积分抵扣订单
- **过期（EXPIRE）**：积分超过有效期自动失效

### 4. 积分规则（PointsRule）

管理员配置的积分发放规则：

- **渠道类型**：ORDER（订单）、COMMENT（评价）、LOGIN（登录）、REGISTER（注册）
- **兑换比例**：例如 1.0 表示 1元=1积分
- **有效期**：积分有效期天数（-1表示永久有效）
- **启用状态**：规则是否生效

## 业务流程

### 一、积分获取流程

#### 1.1 订单完成发放积分

**触发时机**：订单状态变为"已完成"（COMPLETE）

**流程步骤**：

1. 订单系统调用积分系统内部接口 `/api/inner/points/notify/order-success`
2. 积分系统查找 `channelType=ORDER` 且已启用的积分规则
3. 根据订单金额和规则比例计算应发放积分：`积分 = 订单金额 × 比例`
4. 创建积分记录（类型：EARN）
5. 创建积分批次，设置过期时间（根据规则）
6. 更新用户积分账户：总积分 += 发放积分
7. 返回发放的积分数量

**示例**：

- 订单金额：100元
- 规则比例：1.0（1元=1积分）
- 规则有效期：30天
- 结果：用户获得100积分，有效期30天

#### 1.2 评价完成发放积分

**触发时机**：用户发布评价后

**流程步骤**：

1. 评价系统调用积分系统内部接口 `/api/inner/points/notify/review-success`
2. 积分系统查找 `channelType=COMMENT` 且已启用的积分规则
3. 根据规则计算应发放积分（通常为固定值或根据评价内容计算）
4. 创建积分记录和积分批次
5. 更新用户积分账户
6. 返回发放的积分数量

**示例**：

- 评价规则：发布评价奖励10积分
- 规则有效期：永久有效
- 结果：用户获得10积分，永久有效

### 二、积分抵扣流程

#### 2.1 积分冻结（确认订单阶段）

**触发时机**：用户在"确认订单"页面选择使用积分抵扣

**流程步骤**：

1. 订单系统调用积分系统内部接口 `/api/inner/points/trade/freeze`
2. 积分系统验证用户可用积分是否足够
3. 按照FIFO原则查找可用积分批次：
   - 优先选择即将过期的积分
   - 永久有效的积分排在最后
4. 锁定相应数量的积分批次，更新冻结积分
5. 更新用户积分账户：冻结积分 += 冻结数量
6. 返回冻结结果：
   - 使用的积分数量
   - 节省的金额（通常100积分=1元）
   - 剩余可用积分

**示例**：

- 用户选择抵扣500积分
- 系统找到3个批次：
  - 批次A：200积分，3天后过期
  - 批次B：200积分，5天后过期
  - 批次C：300积分，永久有效
- 冻结顺序：批次A（200）+ 批次B（200）+ 批次C（100）
- 结果：锁定500积分，节省5元

#### 2.2 积分扣除（支付成功）

**触发时机**：订单支付成功后

**流程步骤**：

1. 订单系统调用积分系统内部接口 `/api/inner/points/trade/deduct`
2. 积分系统根据临时订单号查找对应的冻结积分批次
3. 将冻结积分转为实际扣除：
   - 更新积分批次：积分数量 -= 扣除数量，冻结积分 -= 扣除数量
   - 更新积分账户：总积分 -= 扣除数量，冻结积分 -= 扣除数量
4. 创建积分消费记录（类型：CONSUME）
5. 清除临时订单号关联
6. 返回扣除结果

**示例**：

- 临时订单号：TEMP_ORD_123456
- 冻结积分：500
- 结果：扣除500积分，创建消费记录

#### 2.3 积分回滚（支付失败/取消订单）

**触发时机**：用户取消订单或支付失败

**流程步骤**：

1. 订单系统调用积分系统内部接口 `/api/inner/points/trade/rollback`
2. 积分系统根据临时订单号查找对应的冻结积分批次
3. 释放冻结的积分：
   - 更新积分批次：冻结积分 -= 回滚数量，可用积分 += 回滚数量
   - 更新积分账户：冻结积分 -= 回滚数量
4. 清除临时订单号关联
5. 返回回滚结果

**示例**：

- 临时订单号：TEMP_ORD_123456
- 冻结积分：500
- 结果：释放500积分，恢复为可用状态

### 三、积分查询流程

#### 3.1 查询积分账户

**触发时机**：用户查看"我的积分"

**流程步骤**：

1. 用户调用接口 `/api/points/account/my`
2. 系统从JWT Token中解析用户ID
3. 查询用户积分账户（如果不存在则自动创建）
4. 返回账户信息：
   - 总积分
   - 冻结积分
   - 可用积分

#### 3.2 查询积分明细

**触发时机**：用户查看积分明细

**流程步骤**：

1. 用户调用接口 `/api/points/record/my`，传入分页参数和可选类型筛选
2. 系统查询用户的积分记录
3. 支持按类型筛选：EARN（获取）、CONSUME（消费）、EXPIRE（过期）
4. 返回分页的积分记录列表

### 四、积分规则管理流程

#### 4.1 创建积分规则

**触发时机**：管理员创建新的积分规则

**流程步骤**：

1. 管理员调用接口 `/api/points/admin/rules`（POST）
2. 设置规则参数：
   - 渠道类型（ORDER/COMMENT/LOGIN/REGISTER）
   - 兑换比例
   - 有效期天数
   - 规则描述
   - 启用状态
3. 系统保存规则
4. 返回创建的规则信息

**示例场景**：

- 双十一活动：创建订单积分规则，比例2.0（双倍积分），有效期30天
- 评价奖励：创建评价积分规则，固定10积分，永久有效

#### 4.2 更新积分规则

**触发时机**：管理员修改现有规则

**流程步骤**：

1. 管理员调用接口 `/api/points/admin/rules/{id}`（PUT）
2. 系统更新规则参数
3. 新规则立即生效，影响后续的积分发放

**示例场景**：

- 调整双十一规则：将比例从2.0调整为1.5
- 修改有效期：将30天调整为60天

#### 4.3 删除积分规则

**触发时机**：管理员删除不需要的规则

**流程步骤**：

1. 管理员调用接口 `/api/points/admin/rules/{id}`（DELETE）
2. 系统软删除规则（标记为已删除）
3. 已删除的规则不再参与积分计算

## 与订单模块的交互流程

### 完整订单流程中的积分交互

#### 场景一：正常订单流程（使用积分抵扣）

```
1. 用户选择商品，进入确认订单页面
   ↓
2. 用户选择使用500积分抵扣
   ↓
3. 订单系统调用积分冻结接口
   → 积分系统：冻结500积分，返回节省5元
   → 订单系统：订单金额 -= 5元
   ↓
4. 用户确认订单，提交支付
   ↓
5. 支付成功
   ↓
6. 订单系统调用积分扣除接口
   → 积分系统：扣除500积分，创建消费记录
   ↓
7. 订单状态更新为"已支付"（PAID）
   ↓
8. 订单完成后，订单状态更新为"已完成"（COMPLETE）
   ↓
9. 订单系统调用积分发放接口
   → 积分系统：根据订单金额发放积分
   → 创建积分记录和积分批次
```

#### 场景二：订单取消流程

```
1. 用户选择使用积分抵扣，积分已冻结
   ↓
2. 用户取消订单
   ↓
3. 订单系统调用积分回滚接口
   → 积分系统：释放冻结的积分
   ↓
4. 订单状态更新为"已取消"（CANCELED）
```

#### 场景三：支付失败流程

```
1. 用户选择使用积分抵扣，积分已冻结
   ↓
2. 用户提交支付
   ↓
3. 支付失败（余额不足、网络错误等）
   ↓
4. 订单系统调用积分回滚接口
   → 积分系统：释放冻结的积分
   ↓
5. 订单保持未支付状态
```

### 积分与订单金额的关系

- **积分抵扣**：100积分 = 1元（可配置）
- **积分获取**：根据积分规则计算，通常 1元 = 1积分（可配置）
- **双重收益**：用户使用积分抵扣订单后，仍可根据订单金额获得新积分

**示例**：

- 订单金额：100元
- 用户使用500积分抵扣（节省5元）
- 实际支付：95元
- 积分发放：根据100元计算，获得100积分（如果规则是1元=1积分）

## 积分过期机制

### 过期时间计算

- 根据积分规则中的 `expireDays` 字段计算
- 公式：过期时间 = 发放时间 + expireDays
- 如果 `expireDays = -1`，表示永久有效

### FIFO原则说明

**为什么需要FIFO？**

- 确保用户优先使用即将过期的积分
- 避免积分浪费
- 提升用户体验

**实现方式**：

- 冻结积分时，按过期时间升序排序
- 优先选择过期时间最早的批次
- 永久有效的积分排在最后

**示例**：

```
用户积分批次：
- 批次A：100积分，3天后过期
- 批次B：200积分，10天后过期
- 批次C：300积分，永久有效

用户选择抵扣150积分：
- 优先使用批次A：100积分
- 再使用批次B：50积分
- 结果：批次A全部用完，批次B剩余150积分
```

## 异常处理

### 积分不足

- **场景**：用户可用积分不足以抵扣
- **处理**：返回错误信息，不允许抵扣
- **用户操作**：减少抵扣数量或取消抵扣

### 规则不存在

- **场景**：对应渠道没有启用的积分规则
- **处理**：不发放积分，返回0
- **影响**：不影响主业务流程（订单、评价正常完成）

### 重复调用

- **场景**：订单完成接口被重复调用
- **处理**：系统应保证幂等性，相同业务ID不重复发放积分
- **实现**：通过业务ID（bizId）去重

## 安全机制

### 内部接口保护

- 所有内部接口（`/api/inner/points/**`）需要内部服务Token验证
- 请求头必须包含：`X-Internal-Service-Token`
- Token不匹配时返回401错误

### 用户接口保护

- 所有用户接口需要JWT Token认证
- 从Token中解析用户ID，确保用户只能操作自己的积分

### 管理员接口保护

- 积分规则管理接口需要管理员权限
- 验证用户是否具有ADMIN权限

## 数据一致性保证

### 事务管理

- 所有积分交易操作都在事务中执行
- 确保积分账户、积分批次、积分记录的一致性
- 操作失败时自动回滚

### 并发控制

- 使用数据库锁机制防止并发问题
- 确保积分冻结和扣除操作的原子性

## 总结

积分系统通过以下机制确保稳定运行：

1. **灵活的规则配置**：支持多种渠道和不同的积分比例
2. **FIFO原则**：优先使用即将过期的积分
3. **完整的交易流程**：冻结→扣除/回滚，确保积分安全
4. **与订单系统紧密集成**：无缝支持积分抵扣和发放
5. **完善的异常处理**：保证主业务流程不受影响
6. **安全机制**：保护内部接口和用户数据

通过这套机制，积分系统能够为用户提供良好的积分体验，同时保证系统的稳定性和数据的一致性。
