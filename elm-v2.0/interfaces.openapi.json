{
  "openapi": "3.0.1",
  "info": {
    "title": "吃饱了吗点餐平台",
    "description": "Tianjin University Software Engineering Project",
    "version": "1.0.0"
  },
  "paths": {
    "/api/points/account/my": {
      "get": {
        "summary": "获取我的积分账户信息",
        "deprecated": false,
        "description": "查询当前登录用户的积分余额，返回当前用户的总积分、冻结积分等信息。后端需从 Token 解析 userId",
        "tags": [],
        "parameters": [],
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "data": {
                      "$ref": "#/components/schemas/PointsAccount"
                    },
                    "message": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "success",
                    "code",
                    "data"
                  ]
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "bearer": []
          }
        ]
      }
    },
    "/api/points/record/my": {
      "get": {
        "summary": "分页查询积分明细",
        "deprecated": false,
        "description": "分页展示积分获取和消费的记录",
        "tags": [],
        "parameters": [
          {
            "name": "page",
            "in": "query",
            "description": "页码, default 1",
            "required": true,
            "schema": {
              "type": "integer"
            }
          },
          {
            "name": "size",
            "in": "query",
            "description": "每页条数, default 20",
            "required": true,
            "schema": {
              "type": "integer"
            }
          },
          {
            "name": "type",
            "in": "query",
            "description": "筛选类型：EARN/CONSUME/EXPIRE",
            "required": false,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "data": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/PointsRecord"
                      }
                    },
                    "message": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "success",
                    "code",
                    "data"
                  ]
                }
              }
            }
          }
        },
        "security": []
      }
    },
    "/api/points/admin/rules": {
      "post": {
        "summary": "新增积分规则",
        "deprecated": false,
        "description": "创建新的积分发放/消耗规则",
        "tags": [],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "integer",
                    "format": "int64"
                  },
                  "createTime": {
                    "type": "string",
                    "format": "date-time"
                  },
                  "updateTime": {
                    "type": "string",
                    "format": "date-time"
                  },
                  "creator": {
                    "type": "integer",
                    "format": "int64",
                    "description": "规则创建人 ID (管理员 ID)"
                  },
                  "updater": {
                    "type": "integer",
                    "format": "int64",
                    "description": "规则最后更新人 ID (管理员 ID)"
                  },
                  "channelType": {
                    "type": "string",
                    "enum": [
                      "ORDER",
                      "COMMENT",
                      "LOGIN",
                      "REGISTER"
                    ],
                    "description": "触发渠道"
                  },
                  "ratio": {
                    "type": "number",
                    "description": "兑换比例（如：1.0 表示 1元=1分）"
                  },
                  "expireDays": {
                    "type": "integer",
                    "description": "有效期天数，-1表示永久有效"
                  },
                  "description": {
                    "type": "string",
                    "description": "规则描述"
                  },
                  "isEnabled": {
                    "type": "boolean"
                  }
                }
              },
              "examples": {}
            }
          }
        },
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "data": {
                      "$ref": "#/components/schemas/PointsRule",
                      "nullable": true
                    },
                    "message": {
                      "type": "string",
                      "nullable": true
                    }
                  }
                }
              }
            }
          }
        },
        "security": []
      },
      "get": {
        "summary": "获取规则列表",
        "deprecated": false,
        "description": "查看当前系统配置的所有规则",
        "tags": [],
        "parameters": [],
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "data": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/PointsRule"
                      }
                    },
                    "message": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "success",
                    "code",
                    "data"
                  ]
                }
              }
            }
          }
        },
        "security": []
      }
    },
    "/api/points/admin/rules/{id}": {
      "put": {
        "summary": "修改积分规则",
        "deprecated": false,
        "description": "更新规则（如调整双十一双倍积分）",
        "tags": [],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PointsRule"
              },
              "examples": {}
            }
          }
        },
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "data": {
                      "$ref": "#/components/schemas/PointsRule",
                      "nullable": true
                    },
                    "message": {
                      "type": "string",
                      "nullable": true
                    }
                  }
                }
              }
            }
          }
        },
        "security": []
      },
      "delete": {
        "summary": "删除积分规则",
        "deprecated": false,
        "description": "删除系统中已有的积分规则",
        "tags": [],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "data": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "security": []
      }
    },
    "/api/inner/points/notify/order-success": {
      "post": {
        "summary": "订单完成（发放积分）",
        "deprecated": false,
        "description": "订单系统调用此接口。积分系统内部会查找 channelType=ORDER 的规则，计算积分，创建 PointsRecord 和 PointsBatch",
        "tags": [],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "userId": {
                    "type": "integer"
                  },
                  "bizId": {
                    "type": "string"
                  },
                  "amount": {
                    "type": "number"
                  },
                  "eventTime": {
                    "type": "string"
                  },
                  "extraInfo": {
                    "type": "string"
                  }
                },
                "required": [
                  "userId",
                  "bizId",
                  "amount",
                  "eventTime",
                  "extraInfo"
                ]
              },
              "example": {
                "userId": 1001,
                "bizId": "ORD_20231111_001",
                "amount": 99.5,
                "eventTime": "2023-11-11T10:00:00Z",
                "extraInfo": "{\"isDouble11\": true}"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    },
                    "data": {
                      "type": "integer"
                    }
                  },
                  "required": [
                    "success",
                    "code",
                    "message",
                    "data"
                  ]
                },
                "example": {
                  "success": true,
                  "code": "200",
                  "message": "积分发放成功",
                  "data": 99
                }
              }
            }
          }
        },
        "security": []
      }
    },
    "/api/inner/points/notify/review-success": {
      "post": {
        "summary": "评价完成发放积分",
        "deprecated": false,
        "description": "评价发布后调用，发放积分",
        "tags": [],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "userId": {
                    "type": "integer"
                  },
                  "bizId": {
                    "type": "string"
                  },
                  "amount": {
                    "description": "评价可能不看金额，只看动作",
                    "type": "integer"
                  },
                  "eventTime": {
                    "type": "string"
                  },
                  "extraInfo": {
                    "type": "string"
                  }
                },
                "required": [
                  "userId",
                  "bizId",
                  "amount",
                  "eventTime",
                  "extraInfo"
                ]
              },
              "example": "{\n  \"userId\": 1001,\n  \"bizId\": \"REV_556677\",\n  \"amount\": 0, // 评价可能不看金额，只看动作\n  \"eventTime\": \"2023-11-12T10:00:00Z\",\n  \"extraInfo\": \"{\\\"hasImage\\\": true, \\\"wordCount\\\": 50}\" // 规则引擎可能判断带图多给分\n}"
            }
          }
        },
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    },
                    "data": {
                      "description": "表示增加了10积分",
                      "type": "integer"
                    }
                  },
                  "required": [
                    "success",
                    "code",
                    "message",
                    "data"
                  ]
                },
                "example": {
                  "success": true,
                  "code": "200",
                  "message": "评价积分发放成功",
                  "data": 10
                }
              }
            }
          }
        },
        "security": []
      }
    },
    "/api/inner/points/trade/freeze": {
      "post": {
        "summary": "积分冻结（积分抵扣）",
        "deprecated": false,
        "description": "用户在“确认订单”页面选择积分抵扣时调用。系统需按有效期优先原则（FIFO）锁定即将过期的积分",
        "tags": [],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "userId": {
                    "type": "integer"
                  },
                  "points": {
                    "description": "用户希望抵扣500积分",
                    "type": "integer"
                  },
                  "tempOrderId": {
                    "description": "临时订单号/交易流水号",
                    "type": "string"
                  }
                },
                "required": [
                  "userId",
                  "points",
                  "tempOrderId"
                ]
              },
              "example": "{\n  \"userId\": 1001,\n  \"points\": 500,        // 用户希望抵扣500积分\n  \"tempOrderId\": \"TEMP_ORD_123456\" // 临时订单号/交易流水号\n}"
            }
          }
        },
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "data": {
                      "type": "object",
                      "properties": {
                        "success": {
                          "type": "boolean"
                        },
                        "pointsUsed": {
                          "type": "integer"
                        },
                        "moneySaved": {
                          "description": "告知订单系统：减去5元",
                          "type": "integer"
                        },
                        "balanceSnap": {
                          "description": "剩余可用",
                          "type": "integer"
                        },
                        "message": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "success",
                        "pointsUsed",
                        "moneySaved",
                        "balanceSnap",
                        "message"
                      ]
                    }
                  },
                  "required": [
                    "success",
                    "code",
                    "data"
                  ]
                },
                "example": {
                  "success": true,
                  "code": "200",
                  "data": {
                    "success": true,
                    "pointsUsed": 500,
                    "moneySaved": 5,
                    "balanceSnap": 2000,
                    "message": "锁定成功"
                  }
                }
              }
            }
          }
        },
        "security": []
      }
    },
    "/api/inner/points/trade/deduct": {
      "post": {
        "summary": "积分扣除",
        "deprecated": false,
        "description": "支付成功后调用，将冻结状态转为实际扣除，并生成消费流水记录。",
        "tags": [],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "userId": {
                    "type": "integer"
                  },
                  "tempOrderId": {
                    "description": "对应之前的冻结记录",
                    "type": "string"
                  },
                  "finalOrderId": {
                    "description": "最终生成的订单号（用于关联流水）",
                    "type": "string"
                  }
                },
                "required": [
                  "userId",
                  "tempOrderId",
                  "finalOrderId"
                ]
              },
              "example": "{\n  \"userId\": 1001,\n  \"tempOrderId\": \"TEMP_ORD_123456\", // 对应之前的冻结记录\n  \"finalOrderId\": \"ORD_20231111_001\" // 最终生成的订单号（用于关联流水）\n}"
            }
          }
        },
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    },
                    "data": {
                      "type": "boolean"
                    }
                  },
                  "required": [
                    "success",
                    "code",
                    "message",
                    "data"
                  ]
                },
                "example": {
                  "success": true,
                  "code": "200",
                  "message": "积分扣除完成",
                  "data": true
                }
              }
            },
            "headers": {}
          }
        },
        "security": []
      }
    },
    "/api/inner/points/trade/rollback": {
      "post": {
        "summary": "积分解冻/回滚",
        "deprecated": false,
        "description": "用户未支付/取消订单，或支付失败时调用。将冻结的积分释放回账户。",
        "tags": [],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "userId": {
                    "type": "integer"
                  },
                  "tempOrderId": {
                    "type": "string"
                  },
                  "reason": {
                    "description": "回滚原因",
                    "type": "string"
                  }
                },
                "required": [
                  "userId",
                  "tempOrderId",
                  "reason"
                ]
              },
              "example": "{\n  \"userId\": 1001,\n  \"tempOrderId\": \"TEMP_ORD_123456\",\n  \"reason\": \"USER_CANCEL\" // 回滚原因\n}"
            }
          }
        },
        "responses": {
          "200": {
            "description": "",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "code": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    },
                    "data": {
                      "type": "boolean"
                    }
                  },
                  "required": [
                    "success",
                    "code",
                    "message",
                    "data"
                  ]
                },
                "example": {
                  "success": true,
                  "code": "200",
                  "message": "积分已回滚",
                  "data": true
                }
              }
            }
          }
        },
        "security": []
      }
    }
  }
}
